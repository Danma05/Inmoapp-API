<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InmoApp - Mis Visitas</title>
    
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Estilos específicos para la tarjeta de visita real */
        .visits-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .visit-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .visit-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        
        .visit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-badge.PENDIENTE { background: #FEF3C7; color: #D97706; }
        .status-badge.CONFIRMADA { background: #D1FAE5; color: #059669; }
        .status-badge.CANCELADA { background: #FEE2E2; color: #DC2626; }

        .visit-img { width: 100%; height: 150px; object-fit: cover; }
        
        .visit-title { font-size: 1.1rem; margin: 0 0 10px 0; color: #111827; }
        
        .visit-details-list { list-style: none; padding: 0; margin: 0 0 15px 0; }
        .visit-details-list li { display: flex; align-items: center; gap: 8px; color: #6B7280; font-size: 0.9rem; margin-bottom: 6px; }
        .visit-details-list li i { width: 20px; text-align: center; color: var(--primary-color); }

        .agent-box { background: #F9FAFB; padding: 12px; border-radius: 8px; margin-top: auto; }
        .agent-info { font-size: 0.85rem; color: #4B5563; }
        .agent-info div { margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }

        .btn-cancel-outline { 
            background: transparent; border: 1px solid #EF4444; color: #EF4444; 
            padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; 
        }
        .btn-cancel-outline:hover { background: #FEF2F2; }

        .tab-active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    </style>
</head>
<body>

    <header class="explorer-header">
        <div class="container header-content">
            <a href="/dashboard" class="brand">
                <div class="logo-box">IA</div>
                <span class="logo-text">InmoApp</span>
            </a>
            <nav class="top-nav">
                <a href="/explorar-menu">Explorar</a>
                <a href="/favoritos">Favoritos</a>
                <a href="/visitas" class="active">Visitas</a>
                <a href="/postulaciones">Postulaciones</a>
            </nav>
            <div class="user-controls">
                <div class="icon-action profile"><i class="fa-regular fa-user"></i></div>
            </div>
        </div>
    </header>

    <div class="container dashboard-body">
        
        <section class="section-header-row" style="flex-direction: column; align-items: flex-start; gap: 5px;">
            <h2 class="dash-title">Mis Visitas</h2>
            <p style="color: #6B7280; font-size: 0.95rem;">Gestiona aquí las visitas que has programado a propiedades.</p>
        </section>

        <div class="visit-tabs">
            <button class="visit-tab-btn tab-active" onclick="filtrarVisitas('TODAS', this)">Todas</button>
            <button class="visit-tab-btn" onclick="filtrarVisitas('PENDIENTE', this)">Pendientes</button>
            <button class="visit-tab-btn" onclick="filtrarVisitas('CONFIRMADA', this)">Confirmadas</button>
        </div>

        <div id="loading-msg" style="text-align:center; padding: 40px;">
            <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i>
            <p>Cargando visitas...</p>
        </div>

        <div class="visits-list" id="visits-container">
            </div>
    </div> 
    
    <footer class="dashboard-footer">
        <div class="container">
            <div class="footer-bottom-dark">
                <p>&copy; 2025 InmoApp. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        let todasLasVisitas = []; // Guardamos aquí para filtrar sin recargar

        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('inmoapp_user');
            if (!userStr) {
                window.location.href = '/';
                return;
            }
            const usuario = JSON.parse(userStr);

            try {
                const res = await fetch(`/visitas?usuarioId=${usuario.id}`);
                const data = await res.json();
                
                todasLasVisitas = data;
                renderizarVisitas(todasLasVisitas);
            } catch (error) {
                console.error(error);
                document.getElementById('visits-container').innerHTML = '<p>Error al cargar visitas.</p>';
            } finally {
                document.getElementById('loading-msg').style.display = 'none';
            }
        });

        // Hacer la función global para usarla en el HTML
        window.filtrarVisitas = (estado, btn) => {
            // Actualizar estilo botones
            document.querySelectorAll('.visit-tab-btn').forEach(b => b.classList.remove('tab-active'));
            btn.classList.add('tab-active');

            if (estado === 'TODAS') {
                renderizarVisitas(todasLasVisitas);
            } else {
                const filtradas = todasLasVisitas.filter(v => v.estado === estado);
                renderizarVisitas(filtradas);
            }
        };

        window.cancelarVisita = async (id) => {
            if(!confirm("¿Seguro quieres cancelar esta visita?")) return;

            try {
                const res = await fetch(`/visitas/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ estado: 'CANCELADA' })
                });

                if(res.ok) {
                    alert("Visita cancelada.");
                    window.location.reload();
                } else {
                    alert("Error al cancelar");
                }
            } catch (e) { console.error(e); }
        };

        function renderizarVisitas(lista) {
            const container = document.getElementById('visits-container');
            
            if (lista.length === 0) {
                container.innerHTML = `<p style="grid-column: 1/-1; text-align:center; color:#666; margin-top:30px;">No tienes visitas en esta categoría.</p>`;
                return;
            }

            container.innerHTML = lista.map(v => {
                const fecha = new Date(v.fecha_visita).toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'});
                const img = v.thumbnail_url || v.imagen_url || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400';
                
                // Botón Cancelar solo si no está ya cancelada
                const btnCancelar = (v.estado === 'PENDIENTE' || v.estado === 'CONFIRMADA') 
                    ? `<button class="btn-cancel-outline" onclick="cancelarVisita(${v.visita_id})"><i class="fa-solid fa-xmark"></i> Cancelar</button>` 
                    : '';

                return `
                <article class="visit-card">
                    <img src="${img}" class="visit-img" alt="${v.direccion}" onerror="this.src='https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400'">
                    <div class="visit-content">
                        <div class="visit-header">
                            <span class="status-badge ${v.estado}">${v.estado}</span>
                            ${btnCancelar}
                        </div>
                        
                        <h3 class="visit-title">${v.direccion}</h3>
                        
                        <ul class="visit-details-list">
                            <li><i class="fa-regular fa-calendar"></i> ${fecha}</li>
                            <li><i class="fa-regular fa-clock"></i> ${v.hora_visita}</li>
                            <li><i class="fa-solid fa-location-dot"></i> ${v.ciudad || 'Ubicación'}</li>
                        </ul>

                        <div class="agent-box">
                            <div style="font-size:0.8rem; font-weight:600; margin-bottom:5px;">Propietario / Agente:</div>
                            <div class="agent-info">
                                <div><i class="fa-regular fa-user"></i> ${v.propietario_nombre}</div>
                                <div><i class="fa-solid fa-phone"></i> ${v.propietario_telefono || 'No disponible'}</div>
                                <div><i class="fa-regular fa-envelope"></i> ${v.propietario_correo}</div>
                            </div>
                        </div>
                         <div style="margin-top: 15px; text-align: center;">
                            <a href="/propiedades-detalles?id=${v.propiedad_id}" style="text-decoration: none; font-size: 0.9rem; color: var(--primary-color); font-weight: 600;">Ver Propiedad</a>
                        </div>
                    </div>
                </article>
                `;
            }).join('');
        }
    </script>
</body>
</html>