<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InmoApp - Mis Favoritos</title>
    
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header class="explorer-header">
        <div class="container header-content">
            <a href="/dashboard" class="brand">
                <div class="logo-box">IA</div>
                <span class="logo-text">InmoApp</span>
            </a>
            <nav class="top-nav">
                <a href="/explorar-menu">Explorar</a>
                <a href="/favoritos" class="active">Favoritos</a>
                <a href="/visitas">Visitas</a>
                <a href="/postulaciones">Postulaciones</a>
            </nav>
            <div class="user-controls">
                <div class="icon-action profile"><i class="fa-regular fa-user"></i></div>
            </div>
        </div>
    </header>

    <div class="container dashboard-body">
        
        <section class="section-header-row" style="align-items: flex-start; flex-direction: column; gap: 5px;">
            <h2 class="dash-title">Mis Favoritos</h2>
            <p style="color: #6B7280; font-size: 0.95rem;">Aquí están las propiedades que has guardado.</p>
        </section>

        <div id="loading-msg" style="text-align: center; padding: 50px;">
            <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i>
            <p>Cargando favoritos...</p>
        </div>

        <section class="dashboard-section">
            <div class="grid-3-cols" id="favorites-grid"></div>
        </section>
    </div> 
    
    <footer class="dashboard-footer">
        <div class="container">
            <div class="footer-bottom-dark">
                <p>&copy; 2025 InmoApp. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('inmoapp_user');
            if (!userStr) {
                window.location.href = '/';
                return;
            }
            const usuario = JSON.parse(userStr);
            const grid = document.getElementById('favorites-grid');
            const loading = document.getElementById('loading-msg');

            try {
                // 1. Cargar Favoritos
                const res = await fetch(`/api/favoritos?usuarioId=${usuario.id}`);
                const data = await res.json();
                
                loading.style.display = 'none';

                if (!data.favoritos || data.favoritos.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 50px; background: white; border-radius: 12px;">
                            <i class="fa-regular fa-heart" style="font-size: 3rem; color: #d1d5db; margin-bottom: 15px;"></i>
                            <h3>Aún no tienes favoritos</h3>
                            <p style="color:#666;">Guarda las propiedades que te gusten mientras exploras.</p>
                            <a href="/explorar-menu" class="btn-filter-action" style="display:inline-block; margin-top:15px; text-decoration:none;">Ir a Explorar</a>
                        </div>`;
                    return;
                }

                // 2. Renderizar
                grid.innerHTML = data.favoritos.map(item => {
                    const img = item.thumbnail_url || item.imagen_url || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400';
                    
                    return `
                    <article class="prop-card-list" style="flex-direction: column; height: auto;">
                        <div class="card-img-list" style="width: 100%; height: 220px;">
                            <img src="${img}" alt="${item.direccion}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=400'">
                            <button class="fav-btn" onclick="eliminarFavorito(${item.propiedad_id})" title="Quitar de favoritos" style="color: var(--brand-red); background: white;">
                                <i class="fa-solid fa-heart"></i>
                            </button>
                        </div>
                        <div class="card-info-list" style="padding: 15px;">
                            <div class="price-red">${item.precio_canon}</div>
                            <h3>${item.direccion}</h3>
                            <p class="location-list" style="color: #666; font-size: 0.9rem;">${item.propietario_nombre || 'Agente'}</p>
                            <div class="specs-list">
                                <span><i class="fa-solid fa-bed"></i> ${item.habitaciones}</span>
                                <span><i class="fa-solid fa-bath"></i> ${item.banos}</span>
                                <span><i class="fa-solid fa-maximize"></i> ${item.area_m2} m²</span>
                            </div>
                            <div style="margin-top: 15px;">
                                <a href="/propiedades-detalles?id=${item.propiedad_id}" style="display: block; text-align: center; background: #f3f4f6; color: #374151; padding: 8px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                                    Ver Detalle
                                </a>
                            </div>
                        </div>
                    </article>
                    `;
                }).join('');

            } catch (error) {
                console.error(error);
                loading.innerHTML = '<p style="color:red">Error cargando favoritos.</p>';
            }

            // Función Global para eliminar
            window.eliminarFavorito = async (propiedadId) => {
                if(!confirm("¿Quitar de tus favoritos?")) return;

                try {
                    const res = await fetch(`/api/favoritos/${propiedadId}?usuarioId=${usuario.id}`, {
                        method: 'DELETE'
                    });

                    if (res.ok) {
                        // Recargar página para actualizar lista
                        window.location.reload();
                    } else {
                        alert("Error al eliminar");
                    }
                } catch (e) {
                    console.error(e);
                }
            };
        });
    </script>
</body>
</html>